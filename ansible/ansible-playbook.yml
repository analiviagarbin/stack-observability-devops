- name: Deploy Stack
  hosts: server
  remote_user: ana
  become: yes

  tasks:
    - name: requirements
      apt:
        name:
          - rsync
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
        update_cache: yes


    - name: add docker GPG apt key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present


    - name: add docker repository
      apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu focal stable
        state: present


    - name: update apt and install engine
      apt:
        name:
          - docker-ce
          - docker-compose-plugin
        state: latest
        update_cache: true


    - name: create /deploy path
      file:
        path: "deploy"
        state: directory


    - name: create /prometheus path
      file: 
        path: "deploy/prometheus"
        state: directory


    - name: create /grafana path
      file: 
        path: "deploy/grafana"
        state: directory


    - name: copy docker-compose.yml
      copy:
        src: "../deploy/docker-compose.yml"
        dest: "deploy/docker-compose.yml"
      register: config_copy

    
    - name: copy prometheus.yml config
      copy:
        src: "../prometheus/prometheus.yml"
        dest: "deploy/prometheus/prometheus.yml"
      register: config_prometheus_copy


    - name: copy grafana data path
      synchronize:
        src: "../grafana/data"
        dest: "deploy/grafana"


    - name: docker compose up 
      command:
        cmd: docker compose up -d
        chdir: "deploy"